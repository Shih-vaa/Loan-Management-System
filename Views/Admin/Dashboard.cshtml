@{
    ViewData["Title"] = "Admin Dashboard";
}

<div class="container mt-5">
    <h2>Welcome..</h2>
@* <p class="lead">Hello, @ViewBag.UserEmail</p> *@



@model LoanManagementSystem.Models.ViewModels.DashboardMetricsViewModel
@{
    ViewData["Title"] = "Admin Dashboard";
}

    <div class="container mt-4">
        <h2 class="mb-4">üìä Admin Dashboard</h2>

        <div class="row g-4">
            <div class="col-md-3">
                <a href="/Lead" class="text-decoration-none">
                    <div class="card text-bg-primary">
                        <div class="card-body">
                            <h5 class="card-title">Total Leads</h5>
                            <p class="display-6">@Model.TotalLeads</p>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-md-3">
                <a href="/Lead?status=pending" class="text-decoration-none">
                    <div class="card text-bg-warning">
                        <div class="card-body">
                            <h5 class="card-title">Pending Leads</h5>
                            <p class="display-6">@Model.PendingLeads</p>
                        </div>
                    </div>
                </a>
            </div>
            <div class="col-md-3">
                <a href="/Lead?status=approved" class="text-decoration-none">
                    <div class="card text-bg-success">
                        <div class="card-body">
                            <h5 class="card-title">Approved Leads</h5>
                            <p class="display-6">@Model.ApprovedLeads</p>
                        </div>
                    </div>
                </a>

            </div>
            <div class="col-md-3">
                <a href="/Customers" class="text-decoration-none">
                    <div class="card text-bg-secondary">
                        <div class="card-body">
                            <h5 class="card-title">Customers</h5>
                            <p class="display-6">@Model.TotalCustomers</p>
                        </div>
                    </div>
                </a>
            </div>

            <div class="col-md-3">
                <a href="/Lead/Index?status=new" class="text-decoration-none">
                    <div class="card text-bg-danger">
                        <div class="card-body">
                            <h5 class="card-title">Unassigned Leads</h5>
                            <p class="display-6">@Model.UnassignedLeadsCount</p>
                        </div>
                    </div>
                </a>
            </div>


            <div class="row g-4 mt-2">
                <div class="col-md-3">
                    <a href="/LeadDocuments/AllDocs" class="text-decoration-none">
                        <div class="card text-bg-dark">
                            <div class="card-body">
                                <h5 class="card-title">Documents Uploaded</h5>
                                <p class="display-6">@Model.TotalDocumentsUploaded</p>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="/LeadDocuments/PendingDocs" class="text-decoration-none">
                        <div class="card text-bg-danger">
                            <div class="card-body">
                                <h5 class="card-title">Pending Docs</h5>
                                <p class="display-6">@Model.PendingDocuments</p>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="/Commission" class="text-decoration-none">
                        <div class="card text-bg-info">
                            <div class="card-body">
                                <h5 class="card-title">Total Commission</h5>
                                <p class="display-6">‚Çπ@Model.TotalCommission.ToString("N2")</p>
                            </div>
                        </div>
                    </a>
                </div>
                <div class="col-md-3">
                    <a href="/Users" class="text-decoration-none">
                        <div class="card text-bg-light">
                            <div class="card-body">
                                <h5 class="card-title">Users</h5>
                                <p class="display-6">@Model.TotalUsers</p>
                            </div>
                        </div>
                    </a>
                </div>
            </div>
        </div>
        <!-- ‚úÖ Team Performance -->
        <h4 class="mt-5">üìà Team Performance Overview</h4>
        <div class="d-flex justify-content-end mb-2">
            <a class="btn btn-sm btn-outline-primary" href="/Admin/ExportMetrics">üì• Export CSV</a>
        </div>
        <table class="table table-bordered table-hover" id="teamTable">
            <thead class="table-light">
                <tr>
                    <th>Team</th>
                    <th>Leads Generated</th>
                    <th>Assigned</th>
                    <th>Docs Uploaded</th>
                    <th>Docs Verified</th>
                    <th>Approved</th>
                    <th>Commission (‚Çπ)</th>
                    <th>üîç</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var t in Model.TeamPerformances)
                {
                    <tr>
                        <td>@t.TeamName</td>
                        <td>@t.TotalLeadsGenerated</td>
                        <td>@t.LeadsAssigned</td>
                        <td>@t.DocumentsUploaded</td>
                        <td>@t.DocumentsVerified</td>
                        <td>@t.LeadsApproved</td>
                        <td>@t.TotalCommission.ToString("N2")</td>
                        <td>
                            <a href="/Admin/TeamDrilldown?teamName=@t.TeamName" class="btn btn-sm btn-outline-info">
                                <i class="bi bi-bar-chart-fill"></i>
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>

        @* <!-- ‚úÖ Team Chart -->
        <h5 class="mt-5">üìä Team-wise Commission Chart</h5>
        <canvas id="teamChart" height="100"></canvas> *@

        <!-- ‚úÖ Lead Status Chart -->
        <h5 class="mt-5">üìå Lead Status Chart</h5>
        <canvas id="leadStatusChart" style="max-width: 400px; max-height: 400px;"></canvas>
        <canvas id="teamPerformanceChart" height="200"></canvas>
        <hr />

        @section Scripts {
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                // üìä Team Commission Chart
                const teamChart = new Chart(document.getElementById('teamChart'), {
                    type: 'bar',
                    data: {
                        labels: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.TeamPerformances.Select(t => t.TeamName))),
                        datasets: [{
                            label: 'Total Commission (‚Çπ)',
                            data: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.TeamPerformances.Select(t => t.TotalCommission))),
                            backgroundColor: 'rgba(40, 167, 69, 0.6)'
                        }]
                    },
                    options: {
                        plugins: {
                            tooltip: { enabled: true }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: '‚Çπ Commission' }
                            }
                        }
                    }
                });

                // üìå Lead Status Chart
                const leadStatusChart = new Chart(document.getElementById('leadStatusChart'), {
                    type: 'pie',
                    data: {
                        labels: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.LeadStatusCounts.Keys)),
                        datasets: [{
                            label: 'Lead Count',
                            data: @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.LeadStatusCounts.Values)),
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 99, 132, 0.6)',
                                'rgba(255, 206, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)'
                            ]
                        }]
                    }
                });
                <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                        const teamLabels = @Html.Raw(Json.Serialize(Model.TeamPerformances.Select(t => t.TeamName)));

                        const leadsGenerated = @Html.Raw(Json.Serialize(Model.TeamPerformances.Select(t => t.TotalLeadsGenerated)));
                        const leadsAssigned = @Html.Raw(Json.Serialize(Model.TeamPerformances.Select(t => t.LeadsAssigned)));
                        const docsUploaded = @Html.Raw(Json.Serialize(Model.TeamPerformances.Select(t => t.DocumentsUploaded)));
                        const docsVerified = @Html.Raw(Json.Serialize(Model.TeamPerformances.Select(t => t.DocumentsVerified)));
                        const leadsApproved = @Html.Raw(Json.Serialize(Model.TeamPerformances.Select(t => t.LeadsApproved)));
                        const commissions = @Html.Raw(Json.Serialize(Model.TeamPerformances.Select(t => Math.Round(t.TotalCommission / 1000)))); // in ‚ÇπK

                        const ctx = document.getElementById('teamPerformanceChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                        data: {
                            labels: teamLabels,
                        datasets: [
                        {label: 'Leads Generated', data: leadsGenerated, backgroundColor: 'rgba(0,123,255,0.6)' },
                        {label: 'Leads Assigned', data: leadsAssigned, backgroundColor: 'rgba(255,193,7,0.6)' },
                        {label: 'Docs Uploaded', data: docsUploaded, backgroundColor: 'rgba(40,167,69,0.6)' },
                        {label: 'Docs Verified', data: docsVerified, backgroundColor: 'rgba(23,162,184,0.6)' },
                        {label: 'Leads Approved', data: leadsApproved, backgroundColor: 'rgba(108,117,125,0.6)' },
                        {label: 'Commission (K ‚Çπ)', data: commissions, backgroundColor: 'rgba(220,53,69,0.6)' }
                        ]
                },
                        options: {
                            responsive: true,
                        plugins: {
                            title: {
                            display: true,
                        text: 'üìä Team Performance Comparison'
                        },
                        tooltip: {mode: 'index', intersect: false },
                    },
                        scales: {
                            x: {stacked: true },
                        y: {
                            beginAtZero: true,
                        title: {display: true, text: 'Count / ‚ÇπK' }
                        }
                    }
                }
            });
            </script>
        }

    </div>
